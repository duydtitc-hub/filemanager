<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tools — Forms</title>
    <link rel="stylesheet" href="style.css">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Tagify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      main{max-width:980px;margin:18px auto;padding:12px}
      .forms-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .tool-form{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2f7}
      .tool-form h3{margin:0 0 8px 0}
      .tool-form input[type=text], .tool-form input[type=number], .tool-form select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #e6e9ef}
      .response-box{margin-top:12px;background:#0f172a;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:240px;overflow:auto}
      .full-width{grid-column:1/-1}
      .recent-tags{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; width:100%; box-sizing:border-box }
      .recent-tags .recent-tag-btn{ padding: .2rem .45rem; font-size: .78rem; white-space:nowrap; box-sizing:border-box; border-radius:6px }
      /* make recent-tag buttons occupy 3 per row on larger mobile, 2 per row on narrow screens */
      .recent-tags .recent-tag-btn{ flex: 0 1 calc(33% - 8px); }
      @media (max-width:420px){ .recent-tags .recent-tag-btn{ flex: 0 1 calc(50% - 8px); } }

      /* TikTok row layout: on small screens stack checkbox and tag input */
      .tiktok-row{ display:flex; gap:8px; align-items:center }
      .tiktok-row .tiktok-checkbox{ flex: 0 0 auto }
      .tiktok-row .tiktok-tags{ flex: 1 1 auto }
      @media (max-width:600px){ .tiktok-row{ flex-direction:column; align-items:flex-start } .tiktok-row .tiktok-tags{ width:100% } }
    </style>
  </head>
  <body>
    <header style="background:linear-gradient(90deg,#0f172a,#334155);color:#fff;padding:12px">
      <h1 style="margin:0">Tools — Forms</h1>
    </header>
    <main>
      <div class="container py-4">
        <p>Trang độc lập cho các form tương tự hành vi trong `DiscordForm.py`.</p>
        <section class="row g-3">
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Tạo tác vụ video</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalVideoTask">Mở form Tạo tác vụ video</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Xóa cache truyện</h3>
              <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalClearCache">Mở form Xóa cache</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Process Series</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProcessSeries">Mở form Process Series</button>
            </div>
          </div>

          <div class="col-12">
            <div class="card p-3 mb-3">
              <h3 class="mb-2">Live Tasks</h3>
              <div id="taskPanel">Đang chờ cập nhật...</div>
            </div>
            <div class="card p-3">
              <h3 class="mb-2">Kết quả / Phản hồi</h3>
              <div id="response" class="response-box">Chưa có phản hồi.</div>
            </div>
          </div>
 
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Xóa episode assets</h3>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDeleteEpisode">Mở form Xóa assets</button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Tải BGAudio</h3>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalDownloadBgaudio">Tải audio vào bgaudio</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="modalVideoTask" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tạo tác vụ video</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="videoTaskForm" class="tool-form">
              <label>Video URL(s)</label>
              <textarea name="video_urls" placeholder="Video URL(s) - cách nhau bằng dấu phẩy hoặc xuống dòng"></textarea>
              <label>Story URL (bắt buộc)</label>
              <textarea name="story_url" placeholder="Story URL" required></textarea>
              <label>Tiêu đề (tùy chọn)</label>
              <input type="text" name="story_name" placeholder="Tiêu đề">
              <label>Background (bgaudio)</label>
              <select class="form-select" name="bg_choice">
                <option value="">-- None --</option>
              </select>
              <div class="mb-2">
                <label>Voice</label>
                <select class="form-select" name="voice">
                  <option value="gfemale">gfemale</option>
                  <option value="gman">gman</option>
                  <option value="nova">nova</option>
                  <option value="echo">echo</option>
                </select>
              </div>
              <div class="mb-2"><label>Part duration (seconds)</label><input type="number" name="part_duration" value="3600" min="1"></div>
              <div class="mb-2"><label>Start from part</label><input type="number" name="start_from_part" value="1" min="1"></div>
              <div class="mb-2"><label>Parts (optional)</label><input type="text" name="parts" placeholder="1,3,5"></div>
              <div class="mb-2"><label>Upload to TikTok</label>
                <div class="tiktok-row">
                  <div class="tiktok-checkbox"><label style="margin:0"><input type="checkbox" name="is_upload_tiktok"> Upload</label></div>
                  <div class="tiktok-tags"><label style="margin:0 8px 4px 0;display:block">Tags</label><input type="text" name="tiktok_tags" placeholder="tag1, tag2" style="width:100%" /></div>
                </div>
              </div>
              <div class="mb-2"><label>Cookies</label>
                <select name="cookies" class="form-select">
                  <option value="">-- None --</option>
                  <option value="PhimTrung.json">PhimTrung.json</option>
                  <option value="DemNgheChuyen.json">DemNgheChuyen.json</option>
                  <option value="BungBu.json">BungBu.json</option>
                </select>
              </div>
              <div class="mb-2"><label>Upload window (hours)</label><input type="number" name="upload_duration_hours" value="24" min="1"></div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> Gồm tóm tắt</label>
                <label><input type="checkbox" name="refresh_audio"> Refresh audio (tạo lại audio)</label>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> Gồm tóm tắt</label>
                <label><input type="checkbox" name="force_refresh"> Force refresh</label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="videoTaskSubmitBtn" type="button" class="btn btn-primary">Gửi tác vụ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalClearCache" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xóa cache truyện</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="clearCacheForm" class="tool-form">
              <label>Story URL</label>
              <input type="text" name="story_url" placeholder="Story URL" required>
              <label>Giữ video cache</label>
              <select name="preserve_video_cache">
                <option value="true">True</option>
                <option value="false">False</option>
              </select>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="clearCacheSubmitBtn" type="button" class="btn btn-secondary">Xóa cache</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProcessSeries" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Process Series</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="processSeriesForm" class="tool-form">
              <label>Start URL (tập 1)</label>
              <input type="text" name="start_url" placeholder="Start URL" required>
              <label>Tiêu đề (tùy chọn)</label>
              <input type="text" name="titles" placeholder="Tiêu đề">
              <label>Số tập tối đa</label>
              <input type="number" name="max_episodes" placeholder="Số tập tối đa" min="1">
              <label>Render mode (0/1/2)</label>
              <input type="text" name="render_mode" placeholder="0">
              <div class="mb-2"><label>Upload to TikTok</label>
                <div class="tiktok-row">
                  <div class="tiktok-checkbox"><label style="margin:0"><input type="checkbox" name="is_upload_tiktok"> Upload</label></div>
                  <div class="tiktok-tags"><label style="margin:0 8px 4px 0;display:block">Tags</label><input type="text" name="tiktok_tags" placeholder="tag1, tag2" style="width:100%" /></div>
                </div>
              </div>
              <div class="mb-2"><label>Cookies</label>
                <select name="cookies" class="form-select">
                  <option value="">-- None --</option>
                  <option value="PhimTrung.json">PhimTrung.json</option>
                  <option value="DemNgheChuyen.json">DemNgheChuyen.json</option>
                  <option value="BungBu.json">BungBu.json</option>
                </select>
              </div>
              <div class="mb-2"><label>Upload window (hours)</label><input type="number" name="upload_duration_hours" value="24" min="1"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="processSeriesSubmitBtn" type="button" class="btn btn-primary">Bắt đầu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalDeleteEpisode" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xóa episode assets</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="deleteEpisodeForm" class="tool-form">
              <label>Title (tên series / base title)</label>
              <input type="text" name="title" placeholder="Tên phim/series (bắt buộc)" required>
              <label>Episode number (1-based, use 0 to delete final outputs)</label>
              <input type="number" name="episode_number" value="1" min="0" required>
              <label>Components (comma-separated names: raw,srt_zh,srt_vi,nar_flac,burned,nar_video)</label>
              <input type="text" name="components" placeholder="raw,srt_zh,nar_flac">
              <label>Or components codes (comma-separated: 1 raw,2 srt_zh,3 srt_vi,4 nar_flac,5 burned,6 nar_video)</label>
              <input type="text" name="components_nums" placeholder="1,4,5">
              <label>Episode numbers (comma-separated to delete multiple, supports 0)</label>
              <input type="text" name="episode_numbers" placeholder="0,1,2">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="deleteEpisodeSubmitBtn" type="button" class="btn btn-danger">Xóa assets</button>
          </div>
        </div>
      </div>
    </div>

      <div class="modal fade" id="modalDownloadBgaudio" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Tải BGAudio vào discord-bot/bgaudio</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="downloadBgaudioForm" class="tool-form">
                <label>Media URL (yt-dlp)</label>
                <input type="text" name="media_url" placeholder="https://youtu.be/..." required>
                <label>Filename (không bao gồm .wav)</label>
                <input type="text" name="filename" placeholder="my_bg_music (optional)">
                <div style="margin-top:8px">
                  <label><input type="checkbox" name="keep_source"> Giữ file nguồn sau chuyển đổi</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button id="downloadBgaudioSubmitBtn" type="button" class="btn btn-success">Tải xuống</button>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Tagify JS -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js" crossorigin="anonymous"></script>
    <script>  
    window.APP_HOST = 'https://sandbox.travel.com.vn/file'
      function apiUrl(path){ return (window.APP_HOST? window.APP_HOST.replace(/\/$/, '') : '') + path }
      async function postJson(path, body){
        try{
          const res = await fetch(apiUrl(path),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
          const text = await res.text()
          try{ const j = JSON.parse(text); return {ok: res.ok, data: j} }
          catch(e){ return {ok: res.ok, data: text} }
        }catch(err){ return {ok:false, data: String(err)} }
      }

      function showResp(obj){ const el = document.getElementById('response'); el.textContent = JSON.stringify(obj, null, 2) }

      // Load bgaudio list and populate bg_choice select
      async function loadBgAudio(){
        try{
          const res = await fetch(apiUrl('/api/bgaudio_list'))
          if(!res.ok) return
          const j = await res.json()
          const files = (j && j.files) || []
          // Only include audio files with .wav or .mp3 extensions
          const filtered = files.filter(f => {
            const name = (f && (f.name || f.rel_path || '')).toString()
            const ext = name.split('.').pop().toLowerCase()
            return ext === 'wav' || ext === 'mp3'
          })
          const sel = document.querySelector('select[name="bg_choice"]')
          if(!sel) return
          sel.innerHTML = ''
          const opt0 = document.createElement('option')
          opt0.value = ''
          opt0.textContent = '-- None --'
          sel.appendChild(opt0)
          filtered.forEach(f=>{
            const o = document.createElement('option')
            o.value = f.rel_path || f.name
            const kb = f.size ? Math.round(f.size/1024) + 'KB' : ''
            o.textContent = (f.name || f.rel_path || '') + (kb ? (' — ' + kb) : '')
            sel.appendChild(o)
          })
        }catch(e){ console.warn('bgaudio load failed', e) }
      }

      window.addEventListener('DOMContentLoaded', loadBgAudio)

      // Render recent tags as clickable buttons below a Tagify input.
      function renderRecentTags(input, tags, tagify){
        try{
          if(!input) return
          let container = input.parentNode && input.parentNode.querySelector('.recent-tags')
          if(!container){
            container = document.createElement('div')
            container.className = 'recent-tags'
            // If the input is inside a flex row (e.g. checkbox + input), place the recent-tags
            // after the parent row so the buttons occupy a full-width row below the controls.
            try{
              const p = input.parentNode
              const cs = p && window.getComputedStyle ? window.getComputedStyle(p) : null
              if(p && cs && cs.display && cs.display.indexOf('flex') === 0){
                p.insertAdjacentElement('afterend', container)
              } else if(input.parentNode){
                input.parentNode.appendChild(container)
              } else {
                input.insertAdjacentElement('afterend', container)
              }
            }catch(e){ if(input.parentNode) input.parentNode.appendChild(container); else input.insertAdjacentElement('afterend', container) }
          }
          container.innerHTML = ''
          if(!tags || !tags.length) return
          tags.forEach(t=>{
            const btn = document.createElement('button')
            btn.type = 'button'
            btn.className = 'btn btn-sm btn-outline-secondary recent-tag-btn'
            btn.style.margin = '0'
            btn.textContent = t
            btn.onclick = (ev)=>{
              ev.preventDefault()
              try{
                if(tagify && typeof tagify.addTags === 'function'){
                  tagify.addTags([t])
                } else {
                  if(input.value && input.value.trim()) input.value = input.value.trim() + ', ' + t
                  else input.value = t
                }
              }catch(e){ console.warn('add recent tag failed', e) }
            }
            container.appendChild(btn)
          })
        }catch(e){ console.warn('renderRecentTags error', e) }
      }

      // Initialize Tagify for TikTok tags input and load suggestions from server
      async function initTiktokTagify(){
        try{
          const inputs = Array.from(document.querySelectorAll('input[name="tiktok_tags"]'))
          if(!inputs.length) return
          // load whitelist once
          let whitelist = []
          try{ const r = await fetch(apiUrl('/api/tiktok_tags')); if(r && r.ok){ const j = await r.json(); whitelist = Array.isArray(j.tags)? j.tags : [] } }catch(e){}
          // Tagify script is included via static <script> so it should be available here.
          inputs.forEach(input=>{
            try{
              if(input._tagify){ try{ input._tagify.removeAllTags(); input._tagify.destroy(); }catch(e){} }
              if(typeof window.Tagify !== 'undefined'){
                try{ input.classList.add('form-control') }catch(e){}
                const tagify = new Tagify(input, { enforceWhitelist: false, whitelist: (whitelist||[]).slice(0,50), dropdown:{enabled:1, maxItems:30, position:'text', highlightFirst:true}, delimiters:',' })
                // render recent tags as buttons under the input (top 10)
                try{ renderRecentTags(input, (whitelist||[]).slice(0,10), tagify) }catch(e){}
                input._tagify = tagify
                // Do NOT persist on 'add' here; persist tags only when the form is submitted.
                tagify.on('add', (e)=>{
                  try{
                    const val = e && e.detail && e.detail.data && e.detail.data.value ? e.detail.data.value.trim() : ''
                    if(!val) return
                    if(whitelist.indexOf(val) === -1){ whitelist.unshift(val) }
                  }catch(err){ /* ignore */ }
                })
                tagify.on('input', function(e){
                  tagify.loading(true)
                  setTimeout(async ()=>{
                    try{
                      const r = await fetch(apiUrl('/api/tiktok_tags'))
                      let list = []
                      if(r && r.ok){ const j = await r.json(); list = Array.isArray(j.tags)? j.tags : [] }
                      const existing = (tagify.value||[]).map(v=>v.value)
                      tagify.settings.whitelist = list.concat(existing)
                      tagify.loading(false)
                      try{ tagify.dropdown.show(e.detail.value) }catch(e){}
                    }catch(err){ tagify.loading(false) }
                  }, 200)
                })
              }
            }catch(err){ console.warn('init Tagify on input error', err) }
          })
        }catch(err){ console.warn('initTiktokTagify error', err) }
      }
      window.addEventListener('DOMContentLoaded', initTiktokTagify)

      document.getElementById('videoTaskForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        // collect tags from Tagify if present
        let _tiktok_tags = undefined
        try{
          const tt = f.querySelector('input[name="tiktok_tags"]')
          if(tt){
            if(tt._tagify && Array.isArray(tt._tagify.value)){
              const arr = tt._tagify.value.map(v=>v.value).filter(Boolean)
              if(arr.length) _tiktok_tags = arr.join(',')
            } else if(tt.value && tt.value.trim()){
              _tiktok_tags = tt.value.trim()
            }
          }
        }catch(e){ /* ignore */ }

        const params = {
          video_url: (f.video_urls.value||'').replace(/\n/g,',').trim(),
          story_url: f.story_url.value.trim(),
          title: f.story_name.value.trim(),
          voice: (f.voice ? f.voice.value : ''),
          bg_choice: f.bg_choice.value.trim(),
          part_duration: f.part_duration && f.part_duration.value ? Number(f.part_duration.value) : undefined,
          start_from_part: f.start_from_part && f.start_from_part.value ? Number(f.start_from_part.value) : undefined,
          is_upload_tiktok: f.is_upload_tiktok && f.is_upload_tiktok.checked ? 'true' : 'false',
          tiktok_tags: _tiktok_tags,
          cookies: f.cookies && f.cookies.value ? f.cookies.value.trim() : undefined,
          upload_duration_hours: f.upload_duration_hours && f.upload_duration_hours.value ? Number(f.upload_duration_hours.value) : undefined,
          refresh_audio: f.refresh_audio && f.refresh_audio.checked ? 'true' : 'false',
          include_summary: f.include_summary && f.include_summary.checked ? 'true':'false',
          parts: f.parts && f.parts.value ? f.parts.value.trim() : undefined,
        }
        let btn = f.querySelector('button[type=submit]') || document.getElementById('videoTaskSubmitBtn');
        if(btn) btn.disabled = true;

        // Build querystring
        const qs = Object.keys(params).filter(k=>params[k]!==undefined && params[k]!=="").map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&')
        const getUrl = apiUrl('/render_tiktok_large_video_unified') + (qs?('?'+qs):'')

        try{
          // Persist any new tags before submitting
          try{
            if(_tiktok_tags){
              const arr = _tiktok_tags.split(',').map(s=>s.trim()).filter(Boolean)
              if(arr.length){ await postJson('/api/tiktok_tags', { tags: arr }) }
            }
          }catch(err){ /* ignore persist errors */ }

          // Try GET first (query params). If server doesn't accept GET, fall back to POST JSON.
          let res = await fetch(getUrl, { method: 'GET' })
          let text = await res.text()
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* non-json or error */ }

          // If GET failed or returned non-OK, fallback to POST
          const postResp = await postJson('/render_tiktok_large_video_unified', params)
          showResp(postResp)
        }catch(err){
          // network or other error: fallback to POST
          try{ const postResp = await postJson('/render_tiktok_large_video_unified', params); showResp(postResp) }catch(e){ showResp({ok:false, data: String(e)}) }
        } finally {
          if(btn) btn.disabled = false;
        }
      });

      document.getElementById('clearCacheForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target; const b = { story_url: f.story_url.value.trim(), preserve_video_cache: f.preserve_video_cache.value }
        let btn = f.querySelector('button[type=submit]') || document.getElementById('clearCacheSubmitBtn');
        if(btn) btn.disabled = true
        const r = await postJson('/clear_story_cache', b)
        if(btn) btn.disabled = false
        showResp(r)
      })

      document.getElementById('processSeriesForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        // collect tags from Tagify if present
        let _tiktok_tags = undefined
        try{
          const tt = f.querySelector('input[name="tiktok_tags"]')
          if(tt){
            if(tt._tagify && Array.isArray(tt._tagify.value)){
              const arr = tt._tagify.value.map(v=>v.value).filter(Boolean)
              if(arr.length) _tiktok_tags = arr.join(',')
            } else if(tt.value && tt.value.trim()){
              _tiktok_tags = tt.value.trim()
            }
          }
        }catch(e){ }

        const b = { start_url: f.start_url.value.trim(), titles: f.titles.value.trim(), max_episodes: f.max_episodes.value ? Number(f.max_episodes.value) : undefined, render_mode: f.render_mode.value.trim(), voice: (f.voice ? f.voice.value : ''), is_upload_tiktok: f.is_upload_tiktok && f.is_upload_tiktok.checked ? 'true' : 'false', tiktok_tags: _tiktok_tags, cookies: f.cookies && f.cookies.value ? f.cookies.value.trim() : undefined, upload_duration_hours: f.upload_duration_hours && f.upload_duration_hours.value ? Number(f.upload_duration_hours.value) : undefined };
        let btn = f.querySelector('button[type=submit]') || document.getElementById('processSeriesSubmitBtn');
        if(btn) btn.disabled = true;

        const qs = Object.keys(b).filter(k=>b[k]!==undefined && b[k]!=='').map(k=>encodeURIComponent(k)+"="+encodeURIComponent(b[k])).join('&')
        const getUrl = apiUrl('/process_series') + (qs?('?'+qs):'')
        try{
          // Persist any new tags before submitting
          try{
            if(_tiktok_tags){
              const arr = _tiktok_tags.split(',').map(s=>s.trim()).filter(Boolean)
              if(arr.length){ await postJson('/api/tiktok_tags', { tags: arr }) }
            }
          }catch(err){ /* ignore persist errors */ }

          let res = await fetch(getUrl, { method: 'GET' })
          let text = await res.text()
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* continue to fallback */ }

          const postResp = await postJson('/process_series', b)
          showResp(postResp)
        }catch(err){
          try{ const postResp = await postJson('/process_series', b); showResp(postResp) }catch(e){ showResp({ok:false, data: String(e)}) }
        } finally { if(btn) btn.disabled = false }
      });

      // Delete episode assets form -> calls DELETE /delete_episode_assets with query params
      document.getElementById('deleteEpisodeForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          title: f.title.value.trim(),
          episode_number: f.episode_number.value ? String(f.episode_number.value) : undefined,
          components: f.components && f.components.value ? f.components.value.trim() : undefined,
          components_nums: f.components_nums && f.components_nums.value ? f.components_nums.value.trim() : undefined,
          episode_numbers: f.episode_numbers && f.episode_numbers.value ? f.episode_numbers.value.trim() : undefined,
        };
        // build querystring
        const qs = Object.keys(params).filter(k=>params[k]!=null && params[k]!=="").map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&')
        const url = apiUrl('/delete_episode_assets') + (qs?('?'+qs):'')
        let btn = f.querySelector('button[type=submit]') || document.getElementById('deleteEpisodeSubmitBtn');
        if(btn) btn.disabled = true;
        try{
          const res = await fetch(url, { method: 'DELETE' })
          const text = await res.text()
          try{ const j = JSON.parse(text); showResp({ok: res.ok, data: j}) }
          catch(e){ showResp({ok: res.ok, data: text}) }
        }catch(err){ showResp({ok:false, data: String(err)}) }
        if(btn) btn.disabled = false;
      });

      // Download BGAudio form handler
      document.getElementById('downloadBgaudioForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const media = (f.media_url && f.media_url.value) ? f.media_url.value.trim() : '';
        const fname = (f.filename && f.filename.value) ? f.filename.value.trim() : undefined;
        const keep = f.keep_source && f.keep_source.checked ? 'true' : 'false';
        const btn = document.getElementById('downloadBgaudioSubmitBtn'); if(btn) btn.disabled = true;
        try{
          if(!media){ showResp({ok:false, error: 'Media URL required'}); return }
          const qs = '?media_url='+encodeURIComponent(media) + (fname?('&filename='+encodeURIComponent(fname)):'') + '&keep_source='+encodeURIComponent(keep)
          const res = await fetch(apiUrl('/api/download-bgaudio') + qs, { method: 'POST' })
          const text = await res.text()
          try{ const j = JSON.parse(text); showResp({ok: res.ok, data: j}); if(res.ok){ loadBgAudio(); } }
          catch(e){ showResp({ok: res.ok, data: text}) }
        }catch(err){ showResp({ok:false, data: String(err)}) }
        if(btn) btn.disabled = false;
      });

      // Modal footer buttons: trigger the inner form submit
      const modalButtons = [
        ['videoTaskSubmitBtn','videoTaskForm','modalVideoTask'],
        ['clearCacheSubmitBtn','clearCacheForm','modalClearCache'],
        ['processSeriesSubmitBtn','processSeriesForm','modalProcessSeries'],
        ['deleteEpisodeSubmitBtn','deleteEpisodeForm','modalDeleteEpisode'],
        ['downloadBgaudioSubmitBtn','downloadBgaudioForm','modalDownloadBgaudio']
      ];
      modalButtons.forEach(([btnId, formId, modalId])=>{
        const btn = document.getElementById(btnId);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const f = document.getElementById(formId);
          if(f && typeof f.requestSubmit === 'function'){
            f.requestSubmit();
          } else if(f){
            // fallback
            f.dispatchEvent(new Event('submit', {bubbles:true, cancelable:true}));
          }
        })
      })
    </script>
  </body>
</html>
