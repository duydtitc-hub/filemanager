<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tools ‚Äî Forms</title>
    <link rel="stylesheet" href="style.css">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Tagify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      main{max-width:980px;margin:18px auto;padding:12px}
      .forms-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .tool-form{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2f7}
      .tool-form h3{margin:0 0 8px 0}
      .tool-form input[type=text], .tool-form input[type=number], .tool-form select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #e6e9ef}
      .response-box{margin-top:12px;background:#0f172a;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:240px;overflow:auto}
      .full-width{grid-column:1/-1}
      .recent-tags{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; width:100%; box-sizing:border-box }
      .recent-tags .recent-tag-btn{ padding: .2rem .45rem; font-size: .78rem; white-space:nowrap; box-sizing:border-box; border-radius:6px }
      /* make recent-tag buttons occupy 3 per row on larger mobile, 2 per row on narrow screens */
      .recent-tags .recent-tag-btn{ flex: 0 1 calc(33% - 8px); }
      @media (max-width:420px){ .recent-tags .recent-tag-btn{ flex: 0 1 calc(50% - 8px); } }

      /* TikTok row layout: on small screens stack checkbox and tag input */
      .tiktok-row{ display:flex; gap:8px; align-items:center }
      .tiktok-row .tiktok-checkbox{ flex: 0 0 auto }
      .tiktok-row .tiktok-tags{ flex: 1 1 auto }
      @media (max-width:600px){ .tiktok-row{ flex-direction:column; align-items:flex-start } .tiktok-row .tiktok-tags{ width:100% } }
    </style>
  </head>
  <body>
    <header style="background:linear-gradient(90deg,#0f172a,#334155);color:#fff;padding:12px;display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between">
      <h1 style="margin:0">Tools ‚Äî Forms</h1>
      <a href="index.html" class="btn btn-outline-light" style="border-radius:999px">&larr; Back to index</a>
    </header>
    <main>
      <div class="container py-4">
        <p>Trang ƒë·ªôc l·∫≠p cho c√°c form t∆∞∆°ng t·ª± h√†nh vi trong `DiscordForm.py`.</p>
        <section class="row g-3">
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">T·∫°o t√°c v·ª• video</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalVideoTask">M·ªü form T·∫°o t√°c v·ª• video</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">X√≥a cache truy·ªán</h3>
              <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalClearCache">M·ªü form X√≥a cache</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Process Series</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProcessSeries">M·ªü form Process Series</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Process Playlist (YTDL)</h3>
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalProcessPlaylist">M·ªü form Playlist YTDL</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Process Video (YTDL)</h3>
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalProcessVideo">M·ªü form Single Video YTDL</button>
            </div>
          </div>

          <div class="col-12">
            <div class="card p-3 mb-3">
              <h3 class="mb-2">Live Tasks</h3>
              <div id="taskPanel">ƒêang ch·ªù c·∫≠p nh·∫≠t...</div>
            </div>
            <div class="card p-3">
              <h3 class="mb-2">K·∫øt qu·∫£ / Ph·∫£n h·ªìi</h3>
              <div id="response" class="response-box">Ch∆∞a c√≥ ph·∫£n h·ªìi.</div>
            </div>
          </div>
 
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">X√≥a episode assets</h3>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDeleteEpisode">M·ªü form X√≥a assets</button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">T·∫£i BGAudio</h3>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalDownloadBgaudio">T·∫£i audio v√†o bgaudio</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Qu·∫£n l√Ω BGAudio</h3>
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalBgAudioManager">Xem &amp; nghe th·ª≠ BGAudio</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">TikTok Upload Failed</h3>
              <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalTikTokFailed">Xem upload th·∫•t b·∫°i</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="modalVideoTask" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">T·∫°o t√°c v·ª• video</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="videoTaskForm" class="tool-form">
              <label>Video URL(s)</label>
              <textarea name="video_urls" placeholder="Video URL(s) - c√°ch nhau b·∫±ng d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng"></textarea>
              <label>Story URL (b·∫Øt bu·ªôc)</label>
              <textarea name="story_url" placeholder="Story URL" required></textarea>
              <label>Ti√™u ƒë·ªÅ (t√πy ch·ªçn)</label>
              <input type="text" name="story_name" placeholder="Ti√™u ƒë·ªÅ">
              <label>Background (bgaudio)</label>
              <select class="form-select" name="bg_choice">
                <option value="">-- None --</option>
              </select>
              <div class="mb-2">
                <label>Voice</label>
                <select class="form-select" name="voice">
                  <option value="gfemale">gfemale</option>
                  <option value="gman">gman</option>
                  <option value="nova">nova</option>
                  <option value="echo">echo</option>
                </select>
              </div>
              <div class="mb-2"><label>Part duration (seconds)</label><input type="number" name="part_duration" value="3600" min="1"></div>
              <div class="mb-2"><label>Start from part</label><input type="number" name="start_from_part" value="1" min="1"></div>
              <div class="mb-2"><label>Parts (optional)</label><input type="text" name="parts" placeholder="1,3,5"></div>
              <div class="mb-2"><label>Upload to TikTok</label>
                <div class="tiktok-row">
                  <div class="tiktok-checkbox"><label style="margin:0"><input type="checkbox" name="is_upload_tiktok"> Upload</label></div>
                  <div class="tiktok-tags"><label style="margin:0 8px 4px 0;display:block">Tags</label><input type="text" name="tiktok_tags" placeholder="tag1, tag2" style="width:100%" /></div>
                </div>
              </div>
              <div class="mb-2"><label>Cookies</label>
                <select name="cookies" class="form-select">
                  <option value="">-- None --</option>
                  <option value="PhimTrung.json">PhimTrung.json</option>
                  <option value="DemNgheChuyen.json">DemNgheChuyen.json</option>
                  <option value="BungBu.json">BungBu.json</option>
                </select>
              </div>
              <div class="mb-2"><label>Upload window (hours)</label><input type="number" name="upload_duration_hours" value="0" min="0"></div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> G·ªìm t√≥m t·∫Øt</label>
                <label><input type="checkbox" name="refresh_audio"> Refresh audio (t·∫°o l·∫°i audio)</label>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> G·ªìm t√≥m t·∫Øt</label>
                <label><input type="checkbox" name="force_refresh"> Force refresh</label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="videoTaskSubmitBtn" type="button" class="btn btn-primary">G·ª≠i t√°c v·ª•</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalClearCache" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">X√≥a cache truy·ªán</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="clearCacheForm" class="tool-form">
              <label>Story URL</label>
              <input type="text" name="story_url" placeholder="Story URL" required>
              <label>Gi·ªØ video cache</label>
              <select name="preserve_video_cache">
                <option value="true">True</option>
                <option value="false">False</option>
              </select>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="clearCacheSubmitBtn" type="button" class="btn btn-secondary">X√≥a cache</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProcessSeries" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Process Series</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="processSeriesForm" class="tool-form">
              <label>Start URL (t·∫≠p 1)</label>
              <input type="text" name="start_url" placeholder="Start URL" required>
              <label>Ti√™u ƒë·ªÅ (t√πy ch·ªçn)</label>
              <input type="text" name="titles" placeholder="Ti√™u ƒë·ªÅ">
              <label>S·ªë t·∫≠p t·ªëi ƒëa</label>
              <input type="number" name="max_episodes" placeholder="S·ªë t·∫≠p t·ªëi ƒëa" min="1">
              <label>Render mode (0/1/2)</label>
              <input type="text" name="render_mode" placeholder="0">
              <label>T·ªëc ƒë·ªô t·ªëi ƒëa thuy·∫øt minh</label>
              <input type="number" name="narration_max_speed_rate" value="1.2" step="0.05" min="0.5">
              <label>Gemini atempo</label>
              <input type="number" name="narration_atempo" value="1.6" step="0.05" min="0.5">
              <div class="mb-2"><label>Upload to TikTok</label>
                <div class="tiktok-row">
                  <div class="tiktok-checkbox"><label style="margin:0"><input type="checkbox" name="is_upload_tiktok"> Upload</label></div>
                  <div class="tiktok-tags"><label style="margin:0 8px 4px 0;display:block">Tags</label><input type="text" name="tiktok_tags" placeholder="tag1, tag2" style="width:100%" /></div>
                </div>
              </div>
              <div class="mb-2"><label>Cookies</label>
                <select name="cookies" class="form-select">
                  <option value="">-- None --</option>
                  <option value="PhimTrung.json">PhimTrung.json</option>
                  <option value="DemNgheChuyen.json">DemNgheChuyen.json</option>
                  <option value="BungBu.json">BungBu.json</option>
                </select>
              </div>
              <div class="mb-2"><label>Upload window (hours)</label><input type="number" name="upload_duration_hours" value="2" min="1"></div>
              <div class="mb-2">
                <label>Background Audio</label>
                <select class="form-select" name="bg_choice">
                  <option value="">-- None --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="processSeriesSubmitBtn" type="button" class="btn btn-primary">B·∫Øt ƒë·∫ßu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProcessPlaylist" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Process Playlist (YTDL)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="processPlaylistForm" class="tool-form">
              <label>Playlist URL</label>
              <input type="text" name="playlist_url" placeholder="YouTube/Facebook playlist URL" required>
              <label>Ti√™u ƒë·ªÅ</label>
              <input type="text" name="title" placeholder="Ti√™u ƒë·ªÅ series">
              <label>Max episodes (s·ªë group/t·∫≠p)</label>
              <input type="number" name="max_episodes" placeholder="ƒê·ªÉ tr·ªëng = t·∫•t c·∫£" min="1">
              <div class="mb-2"><label><input type="checkbox" name="render_full"> Render FULL (gh√©p t·∫•t c·∫£ th√†nh 1 video)</label></div>
              <div class="mb-2"><label><input type="checkbox" name="add_narration" checked> Th√™m thuy·∫øt minh</label></div>
              <div class="mb-2"><label><input type="checkbox" name="with_subtitles" checked> Burn ph·ª• ƒë·ªÅ</label></div>
              <div class="mb-2"><label><input type="checkbox" name="silent_pass"> B·ªè qua l·ªói detect silence</label></div>
              <label>Gi·ªçng TTS</label>
              <select name="narration_voice" class="form-select">
                <option value="vi-VN-Standard-C">vi-VN-Standard-C</option>
                <option value="vi-VN-Standard-A">vi-VN-Standard-A</option>
                <option value="vi-VN-Standard-B">vi-VN-Standard-B</option>
                <option value="vi-VN-Standard-D">vi-VN-Standard-D</option>
              </select>
              <label>T·ªëc ƒë·ªô t·ªëi ƒëa thuy·∫øt minh</label>
              <input type="number" name="narration_max_speed_rate" value="1.2" step="0.05" min="0.5">
              <label>Gemini atempo</label>
              <input type="number" name="narration_atempo" value="1.18" step="0.01" min="0.5">
              <label>√Çm l∆∞·ª£ng thuy·∫øt minh (dB)</label>
              <input type="number" name="narration_volume_db" value="8" step="0.5">
              <div class="mb-2"><label><input type="checkbox" name="narration_replace_audio"> Thay audio g·ªëc</label></div>
              <div class="mb-2">
                <label>Background Audio</label>
                <select class="form-select" name="bg_choice">
                  <option value="">-- None --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="processPlaylistSubmitBtn" type="button" class="btn btn-primary">B·∫Øt ƒë·∫ßu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProcessVideo" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Process Video (YTDL)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="processVideoForm" class="tool-form">
              <label>Video URL</label>
              <input type="text" name="video_url" placeholder="YouTube/Facebook video URL" required>
              <label>Ti√™u ƒë·ªÅ</label>
              <input type="text" name="title" placeholder="Ti√™u ƒë·ªÅ video">
              <div class="mb-2"><label><input type="checkbox" name="add_narration" checked> Th√™m thuy·∫øt minh</label></div>
              <div class="mb-2"><label><input type="checkbox" name="with_subtitles" checked> Burn ph·ª• ƒë·ªÅ</label></div>
              <div class="mb-2"><label><input type="checkbox" name="silent_pass"> B·ªè qua l·ªói detect silence</label></div>
              <label>Gi·ªçng TTS</label>
              <select name="narration_voice" class="form-select">
                <option value="vi-VN-Standard-C">vi-VN-Standard-C</option>
                <option value="vi-VN-Standard-A">vi-VN-Standard-A</option>
                <option value="vi-VN-Standard-B">vi-VN-Standard-B</option>
                <option value="vi-VN-Standard-D">vi-VN-Standard-D</option>
              </select>
              <label>T·ªëc ƒë·ªô t·ªëi ƒëa thuy·∫øt minh</label>
              <input type="number" name="narration_max_speed_rate" value="1.2" step="0.05" min="0.5">
              <label>Gemini atempo</label>
              <input type="number" name="narration_atempo" value="1.18" step="0.01" min="0.5">
              <label>√Çm l∆∞·ª£ng thuy·∫øt minh (dB)</label>
              <input type="number" name="narration_volume_db" value="8" step="0.5">
              <div class="mb-2"><label><input type="checkbox" name="narration_replace_audio"> Thay audio g·ªëc</label></div>
              <div class="mb-2">
                <label>Background Audio</label>
                <select class="form-select" name="bg_choice">
                  <option value="">-- None --</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="processVideoSubmitBtn" type="button" class="btn btn-primary">B·∫Øt ƒë·∫ßu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalDeleteEpisode" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">X√≥a episode assets</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="deleteEpisodeForm" class="tool-form">
              <label>Title (t√™n series / base title)</label>
              <input type="text" name="title" placeholder="T√™n phim/series (b·∫Øt bu·ªôc)" required>
              <label>Episode number (1-based, use 0 to delete final outputs)</label>
              <input type="number" name="episode_number" value="1" min="0" required>
              <label>Components (comma-separated names: raw,srt_zh,srt_vi,nar_flac,burned,nar_video)</label>
              <input type="text" name="components" placeholder="raw,srt_zh,nar_flac">
              <label>Or components codes (comma-separated: 1 raw,2 srt_zh,3 srt_vi,4 nar_flac,5 burned,6 nar_video)</label>
              <input type="text" name="components_nums" placeholder="1,4,5">
              <label>Episode numbers (comma-separated to delete multiple, supports 0)</label>
              <input type="text" name="episode_numbers" placeholder="0,1,2">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button id="deleteEpisodeSubmitBtn" type="button" class="btn btn-danger">X√≥a assets</button>
          </div>
        </div>
      </div>
    </div>

      <div class="modal fade" id="modalDownloadBgaudio" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">T·∫£i BGAudio v√†o discord-bot/bgaudio</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="downloadBgaudioForm" class="tool-form">
                <label>Media URL (yt-dlp)</label>
                <input type="text" name="media_url" placeholder="https://youtu.be/..." required>
                <label>Filename (kh√¥ng bao g·ªìm .wav)</label>
                <input type="text" name="filename" placeholder="my_bg_music (optional)">
                <div style="margin-top:8px">
                  <label><input type="checkbox" name="keep_source"> Gi·ªØ file ngu·ªìn sau chuy·ªÉn ƒë·ªïi</label>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              <button id="downloadBgaudioSubmitBtn" type="button" class="btn btn-success">T·∫£i xu·ªëng</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modalBgAudioManager" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Qu·∫£n l√Ω BGAudio</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <button id="btnRefreshBgAudio" class="btn btn-sm btn-primary">üîÑ Refresh danh s√°ch</button>
                <span id="bgAudioCount" class="ms-2 text-muted"></span>
              </div>
              <div id="bgAudioList" class="list-group">
                <div class="text-center p-3">ƒêang t·∫£i danh s√°ch...</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modalTikTokFailed" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">TikTok Upload Th·∫•t B·∫°i</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <button id="loadFailedBtn" type="button" class="btn btn-primary">üîÑ T·∫£i danh s√°ch</button>
                <button id="retrySelectedBtn" type="button" class="btn btn-success" disabled>‚úÖ Retry ƒë√£ ch·ªçn</button>
                <button id="retryAllBtn" type="button" class="btn btn-warning" disabled>üîÅ Retry t·∫•t c·∫£</button>
                <label class="ms-3">Delay (gi·ªù): <input id="retryDelayInput" type="number" step="0.5" value="0" min="0" style="width:80px"></label>
              </div>
              <div id="failedUploadsContainer">
                <p class="text-muted">Nh·∫•n "T·∫£i danh s√°ch" ƒë·ªÉ xem c√°c upload th·∫•t b·∫°i.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- Tagify JS -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js" crossorigin="anonymous"></script>
    <script>  
    window.APP_HOST = 'https://sandbox.travel.com.vn/file'
      function apiUrl(path){ return (window.APP_HOST? window.APP_HOST.replace(/\/$/, '') : '') + path }
      async function postJson(path, body){
        try{
          const res = await fetch(apiUrl(path),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
          const text = await res.text()
          try{ const j = JSON.parse(text); return {ok: res.ok, data: j} }
          catch(e){ return {ok: res.ok, data: text} }
        }catch(err){ return {ok:false, data: String(err)} }
      }

      function showResp(obj){ const el = document.getElementById('response'); el.textContent = JSON.stringify(obj, null, 2) }

      // Load bgaudio list and populate bg_choice select
      async function loadBgAudio(){
        try{
          const res = await fetch(apiUrl('/api/bgaudio_list'))
          if(!res.ok) return
          const j = await res.json()
          const files = (j && j.files) || []
          // Only include audio files with .wav or .mp3 extensions
          const filtered = files.filter(f => {
            const name = (f && (f.name || f.rel_path || '')).toString()
            const ext = name.split('.').pop().toLowerCase()
            return ext === 'wav' || ext === 'mp3'
          })
          // Populate all bg_choice selects
          const selects = document.querySelectorAll('select[name="bg_choice"]')
          selects.forEach(sel => {
            sel.innerHTML = ''
            const opt0 = document.createElement('option')
            opt0.value = ''
            opt0.textContent = '-- None --'
            sel.appendChild(opt0)
            filtered.forEach(f=>{
              const o = document.createElement('option')
              o.value = f.rel_path || f.name
              const kb = f.size ? Math.round(f.size/1024) + 'KB' : ''
              o.textContent = (f.name || f.rel_path || '') + (kb ? (' ‚Äî ' + kb) : '')
              sel.appendChild(o)
            })
            
            // Add audio preview player after select if not exists
            let audioPreview = sel.parentNode.querySelector('.bg-audio-preview')
            if(!audioPreview){
              audioPreview = document.createElement('audio')
              audioPreview.className = 'bg-audio-preview w-100 mt-2'
              audioPreview.controls = true
              audioPreview.preload = 'none'
              audioPreview.style.height = '32px'
              audioPreview.style.display = 'none'
              sel.parentNode.appendChild(audioPreview)
            }
            
            // Add change listener to update audio preview
            sel.addEventListener('change', function(){
              const selectedFile = this.value
              if(selectedFile){
                const audioUrl = apiUrl('/api/bgaudio_stream?file=' + encodeURIComponent(selectedFile))
                audioPreview.src = audioUrl
                audioPreview.style.display = 'block'
              } else {
                audioPreview.src = ''
                audioPreview.style.display = 'none'
              }
            })
          })
        }catch(e){ console.warn('bgaudio load failed', e) }
      }

      window.addEventListener('DOMContentLoaded', loadBgAudio)

      // Render recent tags as clickable buttons below a Tagify input.
      function renderRecentTags(input, tags, tagify){
        try{
          if(!input) return
          let container = input.parentNode && input.parentNode.querySelector('.recent-tags')
          if(!container){
            container = document.createElement('div')
            container.className = 'recent-tags'
            // If the input is inside a flex row (e.g. checkbox + input), place the recent-tags
            // after the parent row so the buttons occupy a full-width row below the controls.
            try{
              const p = input.parentNode
              const cs = p && window.getComputedStyle ? window.getComputedStyle(p) : null
              if(p && cs && cs.display && cs.display.indexOf('flex') === 0){
                p.insertAdjacentElement('afterend', container)
              } else if(input.parentNode){
                input.parentNode.appendChild(container)
              } else {
                input.insertAdjacentElement('afterend', container)
              }
            }catch(e){ if(input.parentNode) input.parentNode.appendChild(container); else input.insertAdjacentElement('afterend', container) }
          }
          container.innerHTML = ''
          if(!tags || !tags.length) return
          tags.forEach(t=>{
            const btn = document.createElement('button')
            btn.type = 'button'
            btn.className = 'btn btn-sm btn-outline-secondary recent-tag-btn'
            btn.style.margin = '0'
            btn.textContent = t
            btn.onclick = (ev)=>{
              ev.preventDefault()
              try{
                if(tagify && typeof tagify.addTags === 'function'){
                  tagify.addTags([t])
                } else {
                  if(input.value && input.value.trim()) input.value = input.value.trim() + ', ' + t
                  else input.value = t
                }
              }catch(e){ console.warn('add recent tag failed', e) }
            }
            container.appendChild(btn)
          })
        }catch(e){ console.warn('renderRecentTags error', e) }
      }

      // Initialize Tagify for TikTok tags input and load suggestions from server
      async function initTiktokTagify(){
        try{
          const inputs = Array.from(document.querySelectorAll('input[name="tiktok_tags"]'))
          if(!inputs.length) return
          // load whitelist once
          let whitelist = []
          try{ const r = await fetch(apiUrl('/api/tiktok_tags')); if(r && r.ok){ const j = await r.json(); whitelist = Array.isArray(j.tags)? j.tags : [] } }catch(e){}
          // Tagify script is included via static <script> so it should be available here.
          inputs.forEach(input=>{
            try{
              if(input._tagify){ try{ input._tagify.removeAllTags(); input._tagify.destroy(); }catch(e){} }
              if(typeof window.Tagify !== 'undefined'){
                try{ input.classList.add('form-control') }catch(e){}
                const tagify = new Tagify(input, { enforceWhitelist: false, whitelist: (whitelist||[]).slice(0,50), dropdown:{enabled:1, maxItems:30, position:'text', highlightFirst:true}, delimiters:',' })
                // render recent tags as buttons under the input (top 10)
                try{ renderRecentTags(input, (whitelist||[]).slice(0,10), tagify) }catch(e){}
                input._tagify = tagify
                // Do NOT persist on 'add' here; persist tags only when the form is submitted.
                tagify.on('add', (e)=>{
                  try{
                    const val = e && e.detail && e.detail.data && e.detail.data.value ? e.detail.data.value.trim() : ''
                    if(!val) return
                    if(whitelist.indexOf(val) === -1){ whitelist.unshift(val) }
                  }catch(err){ /* ignore */ }
                })
                tagify.on('input', function(e){
                  tagify.loading(true)
                  setTimeout(async ()=>{
                    try{
                      const r = await fetch(apiUrl('/api/tiktok_tags'))
                      let list = []
                      if(r && r.ok){ const j = await r.json(); list = Array.isArray(j.tags)? j.tags : [] }
                      const existing = (tagify.value||[]).map(v=>v.value)
                      tagify.settings.whitelist = list.concat(existing)
                      tagify.loading(false)
                      try{ tagify.dropdown.show(e.detail.value) }catch(e){}
                    }catch(err){ tagify.loading(false) }
                  }, 200)
                })
              }
            }catch(err){ console.warn('init Tagify on input error', err) }
          })
        }catch(err){ console.warn('initTiktokTagify error', err) }
      }
      window.addEventListener('DOMContentLoaded', initTiktokTagify)

      document.getElementById('videoTaskForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        // collect tags from Tagify if present
        let _tiktok_tags = undefined
        try{
          const tt = f.querySelector('input[name="tiktok_tags"]')
          if(tt){
            if(tt._tagify && Array.isArray(tt._tagify.value)){
              const arr = tt._tagify.value.map(v=>v.value).filter(Boolean)
              if(arr.length) _tiktok_tags = arr.join(',')
            } else if(tt.value && tt.value.trim()){
              _tiktok_tags = tt.value.trim()
            }
          }
        }catch(e){ /* ignore */ }

        const params = {
          video_url: (f.video_urls.value||'').replace(/\n/g,',').trim(),
          story_url: f.story_url.value.trim(),
          title: f.story_name.value.trim(),
          voice: (f.voice ? f.voice.value : ''),
          bg_choice: f.bg_choice.value.trim(),
          part_duration: f.part_duration && f.part_duration.value ? Number(f.part_duration.value) : undefined,
          start_from_part: f.start_from_part && f.start_from_part.value ? Number(f.start_from_part.value) : undefined,
          is_upload_tiktok: f.is_upload_tiktok && f.is_upload_tiktok.checked ? 'true' : 'false',
          tiktok_tags: _tiktok_tags,
          cookies: f.cookies && f.cookies.value ? f.cookies.value.trim() : undefined,
          upload_duration_hours: f.upload_duration_hours && f.upload_duration_hours.value ? Number(f.upload_duration_hours.value) : undefined,
          refresh_audio: f.refresh_audio && f.refresh_audio.checked ? 'true' : 'false',
          include_summary: f.include_summary && f.include_summary.checked ? 'true':'false',
          parts: f.parts && f.parts.value ? f.parts.value.trim() : undefined,
        }
        let btn = f.querySelector('button[type=submit]') || document.getElementById('videoTaskSubmitBtn');
        if(btn) btn.disabled = true;

        // Build querystring
        const qs = Object.keys(params).filter(k=>params[k]!==undefined && params[k]!=="").map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&')
        const getUrl = apiUrl('/render_tiktok_large_video_unified') + (qs?('?'+qs):'')

        try{
          // Persist any new tags before submitting
          try{
            if(_tiktok_tags){
              const arr = _tiktok_tags.split(',').map(s=>s.trim()).filter(Boolean)
              if(arr.length){ await postJson('/api/tiktok_tags', { tags: arr }) }
            }
          }catch(err){ /* ignore persist errors */ }

          // Try GET first (query params). If server doesn't accept GET, fall back to POST JSON.
          let res = await fetch(getUrl, { method: 'GET' })
          let text = await res.text()
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* non-json or error */ }

          // If GET failed or returned non-OK, fallback to POST
          const postResp = await postJson('/render_tiktok_large_video_unified', params)
          showResp(postResp)
        }catch(err){
          // network or other error: fallback to POST
          try{ const postResp = await postJson('/render_tiktok_large_video_unified', params); showResp(postResp) }catch(e){ showResp({ok:false, data: String(e)}) }
        } finally {
          if(btn) btn.disabled = false;
        }
      });

      document.getElementById('clearCacheForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target; const b = { story_url: f.story_url.value.trim(), preserve_video_cache: f.preserve_video_cache.value }
        let btn = f.querySelector('button[type=submit]') || document.getElementById('clearCacheSubmitBtn');
        if(btn) btn.disabled = true
        const r = await postJson('/clear_story_cache', b)
        if(btn) btn.disabled = false
        showResp(r)
      })

      document.getElementById('processSeriesForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        // collect tags from Tagify if present
        let _tiktok_tags = undefined
        try{
          const tt = f.querySelector('input[name="tiktok_tags"]')
          if(tt){
            if(tt._tagify && Array.isArray(tt._tagify.value)){
              const arr = tt._tagify.value.map(v=>v.value).filter(Boolean)
              if(arr.length) _tiktok_tags = arr.join(',')
            } else if(tt.value && tt.value.trim()){
              _tiktok_tags = tt.value.trim()
            }
          }
        }catch(e){ }

        const b = {
          start_url: f.start_url.value.trim(),
          titles: f.titles.value.trim(),
          max_episodes: f.max_episodes.value ? Number(f.max_episodes.value) : undefined,
          render_mode: f.render_mode.value.trim(),
          narration_max_speed_rate: f.narration_max_speed_rate && f.narration_max_speed_rate.value ? Number(f.narration_max_speed_rate.value) : 1.2,
            narration_atempo: f.narration_atempo && f.narration_atempo.value ? Number(f.narration_atempo.value) : 1.6,
          voice: (f.voice ? f.voice.value : ''),
          is_upload_tiktok: f.is_upload_tiktok && f.is_upload_tiktok.checked ? 'true' : 'false',
          tiktok_tags: _tiktok_tags,
          cookies: f.cookies && f.cookies.value ? f.cookies.value.trim() : undefined,
          upload_duration_hours: f.upload_duration_hours && f.upload_duration_hours.value ? Number(f.upload_duration_hours.value) : undefined,
          bg_choice: f.bg_choice && f.bg_choice.value ? f.bg_choice.value.trim() : undefined
        };
        let btn = f.querySelector('button[type=submit]') || document.getElementById('processSeriesSubmitBtn');
        if(btn) btn.disabled = true;

        const qs = Object.keys(b).filter(k=>b[k]!==undefined && b[k]!=='').map(k=>encodeURIComponent(k)+"="+encodeURIComponent(b[k])).join('&')
        const getUrl = apiUrl('/process_series') + (qs?('?'+qs):'')
        try{
          // Persist any new tags before submitting
          try{
            if(_tiktok_tags){
              const arr = _tiktok_tags.split(',').map(s=>s.trim()).filter(Boolean)
              if(arr.length){ await postJson('/api/tiktok_tags', { tags: arr }) }
            }
          }catch(err){ /* ignore persist errors */ }

          let res = await fetch(getUrl, { method: 'GET' })
          let text = await res.text()
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* continue to fallback */ }

          const postResp = await postJson('/process_series', b)
          showResp(postResp)
        }catch(err){
          try{ const postResp = await postJson('/process_series', b); showResp(postResp) }catch(e){ showResp({ok:false, data: String(e)}) }
        } finally { if(btn) btn.disabled = false }
      });

      // Delete episode assets form -> calls DELETE /delete_episode_assets with query params
      document.getElementById('deleteEpisodeForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          title: f.title.value.trim(),
          episode_number: f.episode_number.value ? String(f.episode_number.value) : undefined,
          components: f.components && f.components.value ? f.components.value.trim() : undefined,
          components_nums: f.components_nums && f.components_nums.value ? f.components_nums.value.trim() : undefined,
          episode_numbers: f.episode_numbers && f.episode_numbers.value ? f.episode_numbers.value.trim() : undefined,
        };
        // build querystring
        const qs = Object.keys(params).filter(k=>params[k]!=null && params[k]!="").map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&')
        const url = apiUrl('/delete_episode_assets') + (qs?('?'+qs):'')
        let btn = f.querySelector('button[type=submit]') || document.getElementById('deleteEpisodeSubmitBtn');
        if(btn) btn.disabled = true;
        try{
          const res = await fetch(url, { method: 'DELETE' })
          const text = await res.text()
          try{ const j = JSON.parse(text); showResp({ok: res.ok, data: j}) }
          catch(e){ showResp({ok: res.ok, data: text}) }
        }catch(err){ showResp({ok:false, data: String(err)}) }
        if(btn) btn.disabled = false;
      });

      // Process Playlist YTDL form
      document.getElementById('processPlaylistForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          playlist_url: f.playlist_url.value.trim(),
          title: f.title.value.trim(),
          max_episodes: f.max_episodes && f.max_episodes.value ? Number(f.max_episodes.value) : undefined,
          render_full: f.render_full && f.render_full.checked ? 'true' : 'false',
          add_narration: f.add_narration && f.add_narration.checked ? 'true' : 'false',
          with_subtitles: f.with_subtitles && f.with_subtitles.checked ? 'true' : 'false',
            silent_pass: f.silent_pass && f.silent_pass.checked ? 'true' : 'false',
          narration_voice: f.narration_voice && f.narration_voice.value ? f.narration_voice.value : 'vi-VN-Standard-C',
          narration_volume_db: f.narration_volume_db && f.narration_volume_db.value ? Number(f.narration_volume_db.value) : 8.0,
          narration_replace_audio: f.narration_replace_audio && f.narration_replace_audio.checked ? 'true' : 'false',
          narration_max_speed_rate: f.narration_max_speed_rate && f.narration_max_speed_rate.value ? Number(f.narration_max_speed_rate.value) : 1.2,
            narration_atempo: f.narration_atempo && f.narration_atempo.value ? Number(f.narration_atempo.value) : 1.18,
          bg_choice: f.bg_choice && f.bg_choice.value ? f.bg_choice.value.trim() : undefined,
        };
        let btn = f.querySelector('button[type=submit]') || document.getElementById('processPlaylistSubmitBtn');
        if(btn) btn.disabled = true;

        const qs = Object.keys(params).filter(k=>params[k]!==undefined && params[k]!=='').map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&');
        const getUrl = apiUrl('/process_playlist_ytdl') + (qs?('?'+qs):'');
        try{
          let res = await fetch(getUrl, { method: 'GET' });
          let text = await res.text();
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* continue to fallback */ }
          const postResp = await postJson('/process_playlist_ytdl', params);
          showResp(postResp);
        }catch(err){
          try{ const postResp = await postJson('/process_playlist_ytdl', params); showResp(postResp); }catch(e){ showResp({ok:false, data: String(e)}); }
        } finally { if(btn) btn.disabled = false; }
      });

      // Process Video YTDL form
      document.getElementById('processVideoForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          video_url: f.video_url.value.trim(),
          title: f.title.value.trim(),
          add_narration: f.add_narration && f.add_narration.checked ? 'true' : 'false',
          with_subtitles: f.with_subtitles && f.with_subtitles.checked ? 'true' : 'false',
            silent_pass: f.silent_pass && f.silent_pass.checked ? 'true' : 'false',
          narration_voice: f.narration_voice && f.narration_voice.value ? f.narration_voice.value : 'vi-VN-Standard-C',
          narration_volume_db: f.narration_volume_db && f.narration_volume_db.value ? Number(f.narration_volume_db.value) : 8.0,
          narration_replace_audio: f.narration_replace_audio && f.narration_replace_audio.checked ? 'true' : 'false',
          narration_max_speed_rate: f.narration_max_speed_rate && f.narration_max_speed_rate.value ? Number(f.narration_max_speed_rate.value) : 1.2,
            narration_atempo: f.narration_atempo && f.narration_atempo.value ? Number(f.narration_atempo.value) : 1.18,
          bg_choice: f.bg_choice && f.bg_choice.value ? f.bg_choice.value.trim() : undefined,
        };
        let btn = f.querySelector('button[type=submit]') || document.getElementById('processVideoSubmitBtn');
        if(btn) btn.disabled = true;

        const qs = Object.keys(params).filter(k=>params[k]!==undefined && params[k]!=='').map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&');
        const getUrl = apiUrl('/process_video_ytdl') + (qs?('?'+qs):'');
        try{
          let res = await fetch(getUrl, { method: 'GET' });
          let text = await res.text();
          try{ const j = JSON.parse(text); if(res.ok){ showResp({ok: res.ok, data: j}); if(btn) btn.disabled = false; return } }
          catch(e){ /* continue to fallback */ }
          const postResp = await postJson('/process_video_ytdl', params);
          showResp(postResp);
        }catch(err){
          try{ const postResp = await postJson('/process_video_ytdl', params); showResp(postResp); }catch(e){ showResp({ok:false, data: String(e)}); }
        } finally { if(btn) btn.disabled = false; }
      });

      // Download BGAudio form handler
      document.getElementById('downloadBgaudioForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const media = (f.media_url && f.media_url.value) ? f.media_url.value.trim() : '';
        const fname = (f.filename && f.filename.value) ? f.filename.value.trim() : undefined;
        const keep = f.keep_source && f.keep_source.checked ? 'true' : 'false';
        const btn = document.getElementById('downloadBgaudioSubmitBtn'); if(btn) btn.disabled = true;
        try{
          if(!media){ showResp({ok:false, error: 'Media URL required'}); return }
          const qs = '?media_url='+encodeURIComponent(media) + (fname?('&filename='+encodeURIComponent(fname)):'') + '&keep_source='+encodeURIComponent(keep)
          const res = await fetch(apiUrl('/api/download-bgaudio') + qs, { method: 'POST' })
          const text = await res.text()
          try{ const j = JSON.parse(text); showResp({ok: res.ok, data: j}); if(res.ok){ loadBgAudio(); } }
          catch(e){ showResp({ok: res.ok, data: text}) }
        }catch(err){ showResp({ok:false, data: String(err)}) }
        if(btn) btn.disabled = false;
      });

      // Modal footer buttons: trigger the inner form submit
      const modalButtons = [
        ['videoTaskSubmitBtn','videoTaskForm','modalVideoTask'],
        ['clearCacheSubmitBtn','clearCacheForm','modalClearCache'],
        ['processSeriesSubmitBtn','processSeriesForm','modalProcessSeries'],
        ['processPlaylistSubmitBtn','processPlaylistForm','modalProcessPlaylist'],
        ['processVideoSubmitBtn','processVideoForm','modalProcessVideo'],
        ['deleteEpisodeSubmitBtn','deleteEpisodeForm','modalDeleteEpisode'],
        ['downloadBgaudioSubmitBtn','downloadBgaudioForm','modalDownloadBgaudio']
      ];
      modalButtons.forEach(([btnId, formId, modalId])=>{
        const btn = document.getElementById(btnId);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const f = document.getElementById(formId);
          if(f && typeof f.requestSubmit === 'function'){
            f.requestSubmit();
          } else if(f){
            // fallback
            f.dispatchEvent(new Event('submit', {bubbles:true, cancelable:true}));
          }
        })
      })

      // TikTok Failed Uploads Management
      let failedUploadsData = [];

      document.getElementById('loadFailedBtn')?.addEventListener('click', async ()=>{
        const btn = document.getElementById('loadFailedBtn');
        const container = document.getElementById('failedUploadsContainer');
        if(btn) btn.disabled = true;
        try{
          const res = await fetch(apiUrl('/api/tiktok_failed_uploads?limit=100'));
          if(!res.ok) throw new Error('Failed to fetch');
          const data = await res.json();
          failedUploadsData = data.failed_uploads || [];
          
          if(failedUploadsData.length === 0){
            container.innerHTML = '<p class="text-success">‚úÖ Kh√¥ng c√≥ upload th·∫•t b·∫°i n√†o!</p>';
            document.getElementById('retrySelectedBtn').disabled = true;
            document.getElementById('retryAllBtn').disabled = true;
            return;
          }

          // Render table
          let html = '<p class="mb-2">T·ªïng: <strong>' + data.total + '</strong> upload th·∫•t b·∫°i</p>';
          html += '<div class="table-responsive"><table class="table table-sm table-bordered table-hover">';
          html += '<thead><tr><th><input type="checkbox" id="selectAllCheckbox"></th><th>Video</th><th>Title</th><th>Tags</th><th>Error</th><th>Status</th><th>Time</th></tr></thead><tbody>';
          
          failedUploadsData.forEach((entry, idx)=>{
            const item = entry.item || {};
            const videoPath = item.video_path || '';
            const videoName = videoPath.split('/').pop() || videoPath;
            const title = item.title || 'N/A';
            const tags = (item.tags || []).join(', ') || 'N/A';
            
            // Extract detailed error
            let error = entry.error || '';
            if (!error && entry.response) {
              try {
                const respData = JSON.parse(entry.response);
                const errParts = [];
                if (respData.error) errParts.push(respData.error);
                if (respData.stderr) errParts.push('stderr: ' + respData.stderr);
                if (respData.rc) errParts.push('exit_code: ' + respData.rc);
                error = errParts.join(' | ') || 'Upload failed';
              } catch(e) {
                error = 'Upload failed (no details)';
              }
            }
            if (!error) error = 'Unknown error';
            
            const status = entry.status || 500;
            const time = entry.processed_at ? new Date(entry.processed_at * 1000).toLocaleString('vi-VN') : 'N/A';
            const historyIdx = entry.history_index;
            
            html += '<tr>';
            html += '<td><input type="checkbox" class="upload-checkbox" data-index="'+historyIdx+'"></td>';
            html += '<td title="'+videoPath+'">'+videoName+'</td>';
            html += '<td>'+title+'</td>';
            html += '<td>'+tags+'</td>';
            html += '<td><small class="text-danger" style="word-break:break-word">'+error+'</small></td>';
            html += '<td><span class="badge bg-danger">'+status+'</span></td>';
            html += '<td><small>'+time+'</small></td>';
            html += '</tr>';
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
          
          document.getElementById('retrySelectedBtn').disabled = false;
          document.getElementById('retryAllBtn').disabled = false;

          // Handle select all checkbox
          document.getElementById('selectAllCheckbox')?.addEventListener('change', (e)=>{
            document.querySelectorAll('.upload-checkbox').forEach(cb => cb.checked = e.target.checked);
          });

        }catch(err){
          container.innerHTML = '<p class="text-danger">‚ùå L·ªói: ' + String(err) + '</p>';
        }
        if(btn) btn.disabled = false;
      });

      document.getElementById('retrySelectedBtn')?.addEventListener('click', async ()=>{
        const selected = Array.from(document.querySelectorAll('.upload-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
        if(selected.length === 0){
          alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt upload ƒë·ªÉ retry!');
          return;
        }
        await retryUploads(selected);
      });

      document.getElementById('retryAllBtn')?.addEventListener('click', async ()=>{
        if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën retry T·∫§T C·∫¢ ' + failedUploadsData.length + ' upload th·∫•t b·∫°i?')) return;
        const allIndices = failedUploadsData.map(e => e.history_index);
        await retryUploads(allIndices);
      });

      async function retryUploads(indices){
        const btn1 = document.getElementById('retrySelectedBtn');
        const btn2 = document.getElementById('retryAllBtn');
        const delayInput = document.getElementById('retryDelayInput');
        const delay = delayInput ? parseFloat(delayInput.value) || 0 : 0;

        if(btn1) btn1.disabled = true;
        if(btn2) btn2.disabled = true;

        try{
          const res = await fetch(apiUrl('/api/tiktok_retry_upload'), {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              history_indices: indices,
              delay_hours: delay
            })
          });
          
          const data = await res.json();
          
          if(res.ok){
            showResp({
              ok: true,
              message: '‚úÖ Retry th√†nh c√¥ng!',
              requeued: data.requeued,
              skipped: data.skipped,
              errors: data.errors
            });
            alert('‚úÖ ƒê√£ th√™m ' + data.requeued + ' video v√†o queue!\nB·ªè qua: ' + data.skipped);
            // Reload failed list
            document.getElementById('loadFailedBtn')?.click();
          } else {
            showResp({ok: false, error: data.error || 'Retry failed'});
            alert('‚ùå L·ªói: ' + (data.error || 'Unknown error'));
          }
        }catch(err){
          showResp({ok: false, error: String(err)});
          alert('‚ùå L·ªói: ' + String(err));
        }

        if(btn1) btn1.disabled = false;
        if(btn2) btn2.disabled = false;
      }

      // BGAudio Manager functionality
      async function loadBgAudioList(){
        const listEl = document.getElementById('bgAudioList');
        const countEl = document.getElementById('bgAudioCount');
        if(!listEl) return;
        
        listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> ƒêang t·∫£i...</div>';
        
        try{
          const res = await fetch(apiUrl('/api/bgaudio_list'));
          if(!res.ok){
            listEl.innerHTML = '<div class="alert alert-danger">L·ªói t·∫£i danh s√°ch: ' + res.status + '</div>';
            return;
          }
          
          const data = await res.json();
          const files = (data && data.files) || [];
          
          // Filter audio files
          const audioFiles = files.filter(f => {
            const name = (f && (f.name || f.rel_path || '')).toString().toLowerCase();
            return name.endsWith('.wav') || name.endsWith('.mp3') || name.endsWith('.m4a') || name.endsWith('.ogg');
          });
          
          if(countEl) countEl.textContent = '(' + audioFiles.length + ' files)';
          
          if(audioFiles.length === 0){
            listEl.innerHTML = '<div class="alert alert-info">Kh√¥ng c√≥ file audio n√†o.</div>';
            return;
          }
          
          // Build list with audio players
          let html = '';
          audioFiles.forEach((f, idx) => {
            const name = f.name || f.rel_path || 'unknown';
            const relPath = f.rel_path || name;
            const sizeKB = f.size ? Math.round(f.size / 1024) : 0;
            const audioUrl = apiUrl('/api/bgaudio_stream?file=' + encodeURIComponent(relPath));
            
            html += '<div class="list-group-item">';
            html += '<div class="d-flex justify-content-between align-items-start mb-2">';
            html += '<div class="fw-bold">' + escapeHtml(name) + '</div>';
            html += '<span class="badge bg-secondary">' + sizeKB + ' KB</span>';
            html += '</div>';
            html += '<audio controls preload="none" class="w-100" style="height:32px">';
            html += '<source src="' + audioUrl + '" type="audio/' + (name.endsWith('.wav') ? 'wav' : name.endsWith('.mp3') ? 'mpeg' : 'ogg') + '">';
            html += 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.';
            html += '</audio>';
            html += '</div>';
          });
          
          listEl.innerHTML = html;
          
        }catch(err){
          listEl.innerHTML = '<div class="alert alert-danger">L·ªói: ' + escapeHtml(String(err)) + '</div>';
        }
      }
      
      function escapeHtml(text){
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Auto-load bgaudio list when modal is shown
      document.getElementById('modalBgAudioManager')?.addEventListener('shown.bs.modal', loadBgAudioList);
      document.getElementById('btnRefreshBgAudio')?.addEventListener('click', loadBgAudioList);
    </script>
  </body>
</html>

