<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tools — Forms</title>
    <link rel="stylesheet" href="style.css">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      main{max-width:980px;margin:18px auto;padding:12px}
      .forms-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .tool-form{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef2f7}
      .tool-form h3{margin:0 0 8px 0}
      .tool-form input[type=text], .tool-form input[type=number], .tool-form select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #e6e9ef}
      .response-box{margin-top:12px;background:#0f172a;color:#fff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:240px;overflow:auto}
      .full-width{grid-column:1/-1}
    </style>
  </head>
  <body>
    <header style="background:linear-gradient(90deg,#0f172a,#334155);color:#fff;padding:12px">
      <h1 style="margin:0">Tools — Forms</h1>
    </header>
    <main>
      <div class="container py-4">
        <p>Trang độc lập cho các form tương tự hành vi trong `DiscordForm.py`.</p>
        <section class="row g-3">
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Tạo tác vụ video</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalVideoTask">Mở form Tạo tác vụ video</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Xóa cache truyện</h3>
              <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalClearCache">Mở form Xóa cache</button>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Process Series</h3>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProcessSeries">Mở form Process Series</button>
            </div>
          </div>

          <div class="col-12">
            <div class="card p-3 mb-3">
              <h3 class="mb-2">Live Tasks</h3>
              <div id="taskPanel">Đang chờ cập nhật...</div>
            </div>
            <div class="card p-3">
              <h3 class="mb-2">Kết quả / Phản hồi</h3>
              <div id="response" class="response-box">Chưa có phản hồi.</div>
            </div>
          </div>
 
          <div class="col-12 col-md-6">
            <div class="card p-3 text-center">
              <h3 class="mb-3">Xóa episode assets</h3>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalDeleteEpisode">Mở form Xóa assets</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="modalVideoTask" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tạo tác vụ video</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="videoTaskForm" class="tool-form">
              <label>Video URL(s)</label>
              <input type="text" name="video_urls" placeholder="Video URL(s) - cách nhau bằng dấu phẩy hoặc xuống dòng">
              <label>Story URL (bắt buộc)</label>
              <input type="text" name="story_url" placeholder="Story URL" required>
              <label>Tiêu đề (tùy chọn)</label>
              <input type="text" name="story_name" placeholder="Tiêu đề">
              <label>Background (bgaudio)</label>
              <select class="form-select" name="bg_choice">
                <option value="">-- None --</option>
              </select>
              <div class="mb-2">
                <label>Voice</label>
                <select class="form-select" name="voice">
                  <option value="gfemale">gfemale</option>
                  <option value="gman">gman</option>
                  <option value="nova">nova</option>
                  <option value="echo">echo</option>
                </select>
              </div>
              <div class="mb-2"><label>Part duration (seconds)</label><input type="number" name="part_duration" value="3600" min="1"></div>
              <div class="mb-2"><label>Start from part</label><input type="number" name="start_from_part" value="1" min="1"></div>
              <div class="mb-2"><label>Parts (optional)</label><input type="text" name="parts" placeholder="1,3,5"></div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> Gồm tóm tắt</label>
                <label><input type="checkbox" name="refresh_audio"> Refresh audio (tạo lại audio)</label>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label><input type="checkbox" name="include_summary" checked> Gồm tóm tắt</label>
                <label><input type="checkbox" name="force_refresh"> Force refresh</label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="videoTaskSubmitBtn" type="button" class="btn btn-primary">Gửi tác vụ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalClearCache" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xóa cache truyện</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="clearCacheForm" class="tool-form">
              <label>Story URL</label>
              <input type="text" name="story_url" placeholder="Story URL" required>
              <label>Giữ video cache</label>
              <select name="preserve_video_cache">
                <option value="true">True</option>
                <option value="false">False</option>
              </select>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="clearCacheSubmitBtn" type="button" class="btn btn-secondary">Xóa cache</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalProcessSeries" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Process Series</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="processSeriesForm" class="tool-form">
              <label>Start URL (tập 1)</label>
              <input type="text" name="start_url" placeholder="Start URL" required>
              <label>Tiêu đề (tùy chọn)</label>
              <input type="text" name="titles" placeholder="Tiêu đề">
              <label>Số tập tối đa</label>
              <input type="number" name="max_episodes" placeholder="Số tập tối đa" min="1">
              <label>Render mode (0/1/2)</label>
              <input type="text" name="render_mode" placeholder="0">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="processSeriesSubmitBtn" type="button" class="btn btn-primary">Bắt đầu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalDeleteEpisode" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Xóa episode assets</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="deleteEpisodeForm" class="tool-form">
              <label>Title (tên series / base title)</label>
              <input type="text" name="title" placeholder="Tên phim/series (bắt buộc)" required>
              <label>Episode number (1-based, use 0 to delete final outputs)</label>
              <input type="number" name="episode_number" value="1" min="0" required>
              <label>Components (comma-separated names: raw,srt_zh,srt_vi,nar_flac,burned,nar_video)</label>
              <input type="text" name="components" placeholder="raw,srt_zh,nar_flac">
              <label>Or components codes (comma-separated: 1 raw,2 srt_zh,3 srt_vi,4 nar_flac,5 burned,6 nar_video)</label>
              <input type="text" name="components_nums" placeholder="1,4,5">
              <label>Episode numbers (comma-separated to delete multiple, supports 0)</label>
              <input type="text" name="episode_numbers" placeholder="0,1,2">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button id="deleteEpisodeSubmitBtn" type="button" class="btn btn-danger">Xóa assets</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      function apiUrl(path){ return (window.APP_HOST? window.APP_HOST.replace(/\/$/, '') : '') + path }
      async function postJson(path, body){
        try{
          const res = await fetch(apiUrl(path),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
          const text = await res.text()
          try{ const j = JSON.parse(text); return {ok: res.ok, data: j} }
          catch(e){ return {ok: res.ok, data: text} }
        }catch(err){ return {ok:false, data: String(err)} }
      }

      function showResp(obj){ const el = document.getElementById('response'); el.textContent = JSON.stringify(obj, null, 2) }

      // Load bgaudio list and populate bg_choice select
      async function loadBgAudio(){
        try{
          const res = await fetch(apiUrl('/api/bgaudio_list'))
          if(!res.ok) return
          const j = await res.json()
          const files = (j && j.files) || []
          const sel = document.querySelector('select[name="bg_choice"]')
          if(!sel) return
          sel.innerHTML = ''
          const opt0 = document.createElement('option')
          opt0.value = ''
          opt0.textContent = '-- None --'
          sel.appendChild(opt0)
          files.forEach(f=>{
            const o = document.createElement('option')
            o.value = f.rel_path || f.name
            const kb = f.size ? Math.round(f.size/1024) + 'KB' : ''
            o.textContent = f.name + (kb ? (' — ' + kb) : '')
            sel.appendChild(o)
          })
        }catch(e){ console.warn('bgaudio load failed', e) }
      }

      window.addEventListener('DOMContentLoaded', loadBgAudio)

      document.getElementById('videoTaskForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          video_url: (f.video_urls.value||'').replace(/\n/g,',').trim(),
          story_url: f.story_url.value.trim(),
          title: f.story_name.value.trim(),
          voice: (f.voice ? f.voice.value : ''),
          bg_choice: f.bg_choice.value.trim(),
          part_duration: f.part_duration && f.part_duration.value ? Number(f.part_duration.value) : undefined,
          start_from_part: f.start_from_part && f.start_from_part.value ? Number(f.start_from_part.value) : undefined,
          refresh_audio: f.refresh_audio && f.refresh_audio.checked ? 'true' : 'false',
          include_summary: f.include_summary && f.include_summary.checked ? 'true':'false',
          parts: f.parts && f.parts.value ? f.parts.value.trim() : undefined,
        }
        const btn = f.querySelector('button[type=submit]'); btn.disabled = true;
        const url = '/render_tiktok_large_video_unified'
        const r = await postJson(url, params) // keep postJson for full response handling
        btn.disabled = false;
        showResp(r);
      });

      document.getElementById('clearCacheForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target; const b = { story_url: f.story_url.value.trim(), preserve_video_cache: f.preserve_video_cache.value }
        const btn = f.querySelector('button[type=submit]'); btn.disabled = true
        const r = await postJson('/clear_story_cache', b)
        btn.disabled = false
        showResp(r)
      })

      document.getElementById('processSeriesForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target; const b = { start_url: f.start_url.value.trim(), titles: f.titles.value.trim(), max_episodes: f.max_episodes.value ? Number(f.max_episodes.value) : undefined, render_mode: f.render_mode.value.trim(), voice: (f.voice ? f.voice.value : '') };
        const btn = f.querySelector('button[type=submit]'); btn.disabled = true;
        const r = await postJson('/process_series', b);
        btn.disabled = false;
        showResp(r);
      });

      // Delete episode assets form -> calls DELETE /delete_episode_assets with query params
      document.getElementById('deleteEpisodeForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = e.target;
        const params = {
          title: f.title.value.trim(),
          episode_number: f.episode_number.value ? String(f.episode_number.value) : undefined,
          components: f.components && f.components.value ? f.components.value.trim() : undefined,
          components_nums: f.components_nums && f.components_nums.value ? f.components_nums.value.trim() : undefined,
          episode_numbers: f.episode_numbers && f.episode_numbers.value ? f.episode_numbers.value.trim() : undefined,
        };
        // build querystring
        const qs = Object.keys(params).filter(k=>params[k]!=null && params[k]!=="").map(k=>encodeURIComponent(k)+"="+encodeURIComponent(params[k])).join('&')
        const url = apiUrl('/delete_episode_assets') + (qs?('?'+qs):'')
        const btn = f.querySelector('button[type=submit]'); btn.disabled = true;
        try{
          const res = await fetch(url, { method: 'DELETE' })
          const text = await res.text()
          try{ const j = JSON.parse(text); showResp({ok: res.ok, data: j}) }
          catch(e){ showResp({ok: res.ok, data: text}) }
        }catch(err){ showResp({ok:false, data: String(err)}) }
        btn.disabled = false;
      });

      // Modal footer buttons: trigger the inner form submit
      const modalButtons = [
        ['videoTaskSubmitBtn','videoTaskForm','modalVideoTask'],
        ['clearCacheSubmitBtn','clearCacheForm','modalClearCache'],
        ['processSeriesSubmitBtn','processSeriesForm','modalProcessSeries'],
        ['deleteEpisodeSubmitBtn','deleteEpisodeForm','modalDeleteEpisode']
      ];
      modalButtons.forEach(([btnId, formId, modalId])=>{
        const btn = document.getElementById(btnId);
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const f = document.getElementById(formId);
          if(f && typeof f.requestSubmit === 'function'){
            f.requestSubmit();
          } else if(f){
            // fallback
            f.dispatchEvent(new Event('submit', {bubbles:true, cancelable:true}));
          }
        })
      })
    </script>
  </body>
</html>
